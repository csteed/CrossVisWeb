<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta author="Chad A. Steed">
  <meta description="CrossVis: A multivariate visual analytics tool for data exploration.">

  <link rel="stylesheet" href="js/bootstrap-4.5.2-dist/css/bootstrap.min.css">

  <style>
    @font-face {
        font-family: "Rammetto One";
        src: url("./fonts/Rammetto_One/RammettoOne-Regular.ttf");
    }

    main>.container {
      padding: 100px 15px 0;
    }

    .navbar-brand {
      padding-top: .3rem;
      padding-bottom: .4rem;
      font-size: 1.8rem;
      /* color: silver; */
      font-family: 'Rammetto One', cursive;
      float: none;
    }
  </style>

  <title>CrossVis Web - ORNL VISTA Lab</title>
</head>

<body>
  <nav class="navbar fixed-top navbar-expand-lg shadow navbar-dark bg-dark">
    <a class="navbar-brand" href="#" style="color: #DCDCDC;">
      CrossVis
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <div class="navbar-nav mr-auto">
        <div class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            View Sample Data
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            <a class="dropdown-item" href="#" id="loadCarsButton">'83 ASA Cars</a>
            <a class="dropdown-item" href="#" id="loadAAPLButton">S&P 500 Sample (Apple)</a>
          </div>
        </div>
        <div class="nav-item">
          <a class="nav-link" href="#" data-toggle="modal" data-target="#settingsModal">Settings</a>
        </div>
        <div class="nav-item">
          <a class="nav-link" href="#" id="redrawButton">Redraw Chart</a>
        </div>
        <div class="nav-item">
          <a class="nav-link" href="#" data-toggle="modal" data-target="#helpModal">Help</a>
        </div>
      </div>
      <form class="form-inline my-2 my-lg-0">
        <img src="./img/vista-logo.png" height="48" class="d-inline-block align-top" alt="VISTA">
      </form>
    </div>
  </nav>

  <div class="modal fade" id="helpModal" tabindex="-1" role="dialog" aria-labelledby="helpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="settingsModalLabel">Usage Instructions</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>This page shows an interactive parallel coordinate plot for exploring multivariate data. It uses a combination of SVG elements and HTML Canvas via the d3.js library to support larger files than SVG graphics can support alone.</p>
          <p>Use the 'Choose CSV File' button to open a local CSV formatted text file. Columns are automatically parsed using d3.js auto typing. Date, numeric, and Boolean data types are shown as axes in the parallel coordinate plot. Columns of other data types are ignored.</p>
          <p>Sample files can be shown from the 'Load Sample Data' button.</p>
          <p>Lines in the plot can be selected by dragging ranges on any of the axes.</p>
          <p>The 'Redraw' button can be used to regenerate the plot. If the window is resized, regenerating the plot will adjust the chart widths to fill the available space.</p>
          <p>The 'Settings' button can be used to control several visual parameters of the charts.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-dismiss="modal">Ok</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="settingsModal" tabindex="-1" role="dialog" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="settingsModalLabel">View Settings</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-row">
              <div class="form-group col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="" id="showAxisTicksCheck" checked>
                  <label class="form-check-label" for="showAxisTicksCheck">
                    Show Axis Ticks
                  </label>
                </div>
              </div>
              <div class="form-group col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="" id="showAxisLabelsCheck" checked>
                  <label class="form-check-label" for="showAxisLabelsCheck">
                    Show Axis Labels
                  </label>
                </div>
              </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="showSelectedCheck" checked>
                        <label class="form-check-label" for="showSelectedCheck">
                            Show Selected Lines
                        </label>
                    </div>
                </div>
                <div class="form-group col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="showUnselectedCheck" checked>
                        <label class="form-check-label" for="showUnselectedCheck">
                            Show Unselected Lines
                        </label>
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="heightRange">Selected Line Opacity:</label>
                    <input type="range" class="custom-range" step="0.01" min="0" max="1" value=".15" id="selectedLineOpacityRange">
                </div>
                <div class="form-group col-md-6">
                    <label for="heightRange">Unselected Line Opacity:</label>
                    <input type="range" class="custom-range" step="0.01" min="0" max="1" value=".15" id="unselectedLineOpacityRange">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-12">
                    <label for="heightRange">Chart Height:</label>
                    <input type="range" class="custom-range" min="200" max="800" value="350" id="heightRange">
                </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <!-- <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button> -->
          <button type="button" class="btn btn-primary" data-dismiss="modal">Ok</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Begin page content -->
  <main role="main" class="flex-shrink-0">
    <div class="container">
      <div class="custom-file">
        <input type="file" class="custom-file-input mr-sm-2" id="fileInput">
        <label id="fileLabel" class="custom-file-label my-2 my-sm-0" for="fileInput">Open CSV File</label>
      </div>
    </div>
    <br/>

    <div class="container-fluid pt-3">
      <div id="chart" style="position: relative;" class="mx-4"></div>
      <hr>
      <center>
          <p>&copy; <a href="https://vis.ornl.gov">Oak Ridge National Laboratory</a>
              <script type="text/javascript">
                  document.write(new Date().getFullYear());
              </script>
          </p>
      </center>
    </div>
  </main>

  <script src="js/d3.min.js"></script>
  <script src="js/d3-array.min.js"></script>
  <script src="js/pcpChart.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous">
  </script>
  <script src="js/bootstrap-4.5.2-dist/js/bootstrap.min.js"></script>

  <script>
    const chartMargin = {top: 20, right: 30, bottom: 20, left: 30};
    var reader;
    var chart;
    var chartData;
    const redrawButton = document.getElementById('redrawButton');
    const fileInput = document.getElementById('fileInput');
    const heightRange = document.getElementById('heightRange');
    const showUnselectedCheck = document.getElementById('showUnselectedCheck');
    const showSelectedCheck = document.getElementById('showSelectedCheck');
    const showAxisTicksCheck = document.getElementById('showAxisTicksCheck');
    const showAxisLabelsCheck = document.getElementById('showAxisLabelsCheck');
    const selectedLineOpacityRange = document.getElementById('selectedLineOpacityRange');
    const unselectedLineOpacityRange = document.getElementById('unselectedLineOpacityRange');
    const loadCarsButton = document.getElementById('loadCarsButton');
    const loadAAPLButton = document.getElementById('loadAAPLButton');
    const loadSampleDataDropdown = document.getElementById('sampleDataDropdown');

    loadCarsButton.addEventListener('click', () => loadCarsData());
    loadAAPLButton.addEventListener('click', () => loadAAPLData());

    redrawButton.addEventListener('click', () => createChart());

    showAxisLabelsCheck.addEventListener('change', () => {
      if (chart) {
        chart.showAxisTickLabels(showAxisLabelsCheck.checked);
      }
    });
    showAxisTicksCheck.addEventListener('change', () => {
      if (chart) {
        chart.showAxisTicks(showAxisTicksCheck.checked);
      }
    });
    selectedLineOpacityRange.addEventListener('change', () => {
      if (chart) {
        // console.log(selectedLineOpacityRange.value);
        chart.selectedLineOpacity(selectedLineOpacityRange.value);
      }
    });

    unselectedLineOpacityRange.addEventListener('change', () => {
      if (chart) {
        chart.unselectedLineOpacity(unselectedLineOpacityRange.value);
      }
    });    

    showUnselectedCheck.addEventListener('change', () => {
      if (chart) {
        chart.showUnselectedLines(showUnselectedCheck.checked);
      }
    });

    showSelectedCheck.addEventListener('change', () => {
      if (chart) {
        chart.showSelectedLines(showSelectedCheck.checked);
      }
    });

    heightRange.addEventListener('change', () => {
      // console.log('height changed');
      // TODO: add height change capablity to pcpChart so that recreating change isn't required
      createChart();
    });

    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      reader = new FileReader();
      reader.addEventListener('load', parseFile, false);
      if (file) {
        reader.readAsText(file);
        $('#fileLabel').html(file.name);
      }
    });

    const parseFile = () => {
      data = d3.csvParse(reader.result, d3.autoType);

      console.log(data);

      let dimensions = data.columns.map(c => {
        if (data[0][c] instanceof Date) return {name: c, type: 'temporal'};
        else if (data[0][c] instanceof Boolean) return {name: c, type: 'categorical'};
        else if (typeof data[0][c] === 'string') return {name: c, type: 'categorical'};
        else if (typeof data[0][c] === 'number') return {name: c, type: 'numerical'};
        else return {name: c, type: 'unknown'};
      });
      dimensions = dimensions.filter(d => d.type !== 'unknown');

      const tuples = data.map(d => {
        let tuple = {};
        dimensions.map(dim => tuple[dim.name] = d[dim.name]);
        return tuple;
      });

      chartData = {dimensions: dimensions, tuples: tuples};
      createChart();
    };

    function loadCarsData() {
      d3.csv("data/cars-cat.csv", d3.autoType)
        .then(data => {
          chartData = {
            dimensions: [
              {name: 'MPG', type: 'numerical'},
              {name: 'Cylinders', type: 'categorical'},
              {name: 'Origin', type: 'categorical'},
              {name: 'Displacement', type: 'numerical'},
              {name: 'HP', type: 'numerical'},
              {name: 'Weight', type: 'numerical'},
              {name: 'Acceleration', type: 'numerical'},
              {name: 'Year', type: 'numerical'}
            ],
            tuples: data.map(d => {
              return {
                // MPG: Math.random() > 0.5 ? d.MPG : NaN,
                MPG: d.MPG,
                Cylinders: d.Cylinders,
                Displacement: d.Displacement,
                HP: d.HP,
                Weight: d.Weight,
                Acceleration: d.Acceleration,
                Year: d.Year,
                Origin: d.Origin
              }
            })
          };
          createChart();
        })
        .catch(error => {
          console.log(error);
        });
    };

    function loadAAPLData() {
      // console.log('loading AAPL data');
      d3.csv("data/AAPL_data.csv", d3.autoType)
        .then(data => {
          chartData = {
            dimensions: [
              {name: 'Date', type: 'temporal'},
              {name: 'Open', type: 'numerical'},
              {name: 'High', type: 'numerical'},
              {name: 'Low', type: 'numerical'},
              {name: 'Close', type: 'numerical'},
              {name: 'Volume', type: 'numerical'},
            ],
            tuples: data.map(d => {
              return {
                Date: d.date,
                Open: d.open,
                High: d.high,
                Low: d.low,
                Close: d.close,
                Volume: d.volume
              }
            })
          };
          createChart();
        })
        .catch(error => { console.log(error); });
    };

    function createChart() {
      d3.select('#chart').selectAll('*').remove();
      if (chartData) {
        const chartWidth = document.getElementById('chart').clientWidth;
        const chartHeight = heightRange.value;

        document.getElementById('chart').style.height = `${chartHeight}px`;

        let opacity = chartData.tuples.length > 2000 ? 0.1 : chartData.tuples.length < 500 ? 0.7 : 1 - chartData.tuples.length / 2500;
        // console.log(opacity);
        selectedLineOpacityRange.value = opacity;
        unselectedLineOpacityRange.value = opacity;

        chart = pcpChart()
          .width(chartWidth)
          .height(chartHeight)
          .showUnselectedLines(showUnselectedCheck.checked)
          .showSelectedLines(showSelectedCheck.checked)
          .selectedLineOpacity(opacity)
          .showAxisTicks(showAxisTicksCheck.checked)
          .showAxisTickLabels(showAxisLabelsCheck.checked)
          .unselectedLineOpacity(unselectedLineOpacityRange.value)
          .margin(chartMargin);
        d3.select('#chart').call(chart, chartData);
      }
    }

  </script>
</body>

</html>
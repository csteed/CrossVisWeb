<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta author="Chad A. Steed">
  <meta description="CrossVis: A multivariate visual analytics tool for data exploration.">

  <link rel="stylesheet" type="text/css" href="./js/Semantic-UI/semantic.min.css">

  <title>CrossVis Web - ORNL VISTA Lab</title>

  <style>
    ui.action.input input[type="file"] {
      display: none;
    }
  </style>
</head>

<body>
  <input id="fileInput" type="file" style="display: none;">
        
  <div class="ui inverted borderless menu">
    <div class="ui medium header item">
      CrossVis
    </div>
    <div class="ui dropdown item">
      Load Data
      <i class="dropdown icon"></i>
      <div class="menu">
        <a class="item loadLocalFileItem">Load Local CSV File</a>
        <div class="item">
          <i class="dropdown icon"></i>
          <div class="header">Load Sample Data</div>
          <div class="menu">
            <a class="item loadCarsDataItem">'83 ASA Cars Dataset</a>
            <a class="item loadAAPLDataItem">S&amp;P500 Stock Data (AAPL)</a>
            <a class="item loadTop500DataItem">Top500 SuperComputing List</a>
          </div>
        </div>
      </div>
    </div>
    <!-- <a class="ui item loadDataItem">
      Load Data
    </a> -->
    <a class="ui item settingsItem">
      Plot Settings
    </a>
    <a class="ui item redrawItem">
      Redraw
    </a>
    <a class="ui item helpItem">
      Help
    </a>
    <div class="right menu">
      <div class="ui item">
        <img class="ui image" src="./img/vista-logo.png" height="40px">
      </div>
    </div>
  </div>

  <div style="margin: 4px 4px 4px 4px;">
    <div class="ui segment">
      <h3>Parallel Coordinates Plot</h3>
      <div id="pcpChart" style="position: relative;"></div>
    </div>
  </div>

  <div class="ui divider"></div>
    <center>
      <h4>&copy; <a href="https://www.ornl.gov">Oak Ridge National Laboratory</a>
          <script type="text/javascript">
              document.write(new Date().getFullYear());
          </script>
      </h4>
    </center>
    <br/><br/><br/>
  
  <input type="file" style="display: none;">
  <!-- <div class="ui tiny modal loadDataModal">
    <i class="close icon"></i>
    <div class="header">
      Load Data
    </div>
    <div class="content">
      <form class="ui form loadDataForm">
        <h4 class="ui dividing header">Open Local Data File</h4>
        <div class="field">
          <div class="ui action input">
            <input type="text" placeholder="File" readonly>
            <input type="file" style="display: none;">
            <div class="ui icon button">
              <i class="attach icon"></i>
            </div>
          </div>
        </div>
        <h4 class="ui dividing header">Load Sample Data</h4>
        <div class="field">
          <label>Sample Data</label>
          <div class="ui selection dropdown">
            <input type="hidden" name="sampleData">
            <i class="dropdown icon"></i>
            <div class="default text">Select Sample Data</div>
            <div class="menu">
              <div class="item" data-value="cars">'83 ASA Cars</div>
              <div class="item" data-value="apple">S&amp;P 500 Sample Data (APPL)</div>
              <div class="item" data-value="top500">Top500 SuperComputing Rankings</div>
            </div>
          </div>
        </div>
      </form>
    </div>
    <div class="actions">
      <div class="ui positive left labeled icon button">
        <i class="check icon"></i>
        Open
      </div>
    </div>
  </div> -->


  <div class="ui tiny modal settingsModal">
    <i class="close icon"></i>
    <div class="header">
      Plot Settings
    </div>
    <div class="content">
      <form class="ui form plotSettingsForm">
        <h4 class="ui dividing header">Display Settings</h4>
        <div class="two fields">
          <div class="inline field">
            <div class="ui checked checkbox showAxisTicks">
              <input type="checkbox" checked="">
              <label>Show Axis Ticks</label>
            </div>
          </div>
          <div class="inline field">
            <div class="ui checked checkbox showAxisLabels">
              <input type="checkbox" checked="">
              <label>Show Axis Labels</label>
            </div>
          </div>
        </div>
        <div class="field">
          <label>Chart Height</label>
          <input type="range" class="ui fluid range" id="chartHeightRange" min="200" max="1000" value="350" style="width: 100%;">
        </div>
        <h4 class="ui dividing header">Polyline Settings</h4>
        <div class="two fields">
          <div class="inline field">
            <div class="ui checked checkbox showSelectedLines">
              <input type="checkbox" checked="">
              <label>Show Selected Lines</label>
            </div>
          </div>
          <div class="inline field">
            <div class="ui checked checkbox showUnselectedLines">
              <input type="checkbox" checked="">
              <label>Show Unselected Lines</label>
            </div>
          </div>
        </div>
        <div class="two fields">
          <div class="field">
            <label>Selected Line Opacity</label>
            <input type="range" class="ui fluid range" id="selectedLineOpacityRange" min="5" max="100" value="20" style="width: 100%;">
          </div>
          <div class="field">
            <label>Unselected Line Opacity</label>
            <input type="range" class="ui fluid range" id="unselectedLineOpacityRange" min="5" max="100" value="10" style="width: 100%;">
          </div>
        </div>
      </form>
    </div>
    <div class="actions">
      <div class="ui positive left labeled icon button">
        <i class="close icon"></i>
        Close
      </div>
    </div>
  </div>
  
  <script
    src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous">
  </script>
  <script src="./js/Semantic-UI/semantic.min.js"></script>
  <script src="js/d3.min.js"></script>
  <script src="js/d3-array.min.js"></script>
  <script src="js/pcpChart.js"></script>

  <script>
    const chartMargin = {top: 20, right: 30, bottom: 20, left: 30};
    var reader;
    var chart;
    var chartData;

    // const redrawButton = document.getElementById('redrawButton');
    // const fileInput = document.getElementById('fileInput');
    const heightRange = document.getElementById('heightRange');
    const selectedLineOpacityRange = document.getElementById('selectedLineOpacityRange');
    const unselectedLineOpacityRange = document.getElementById('unselectedLineOpacityRange');
    // const loadCarsButton = document.getElementById('loadCarsButton');
    // const loadAAPLButton = document.getElementById('loadAAPLButton');
    // const loadSampleDataDropdown = document.getElementById('sampleDataDropdown');

    const getSelectedLineOpacity = () => {
      return selectedLineOpacityRange.value / 100.;
    };

    const getUnselectedLineOpacity = () => {
      return unselectedLineOpacityRange.value / 100.;
    };

    const getChartHeight = () => {
      return document.getElementById('chartHeightRange').value;
    };

    const getShowAxisTicks = () => {
      return $('.showAxisTicks').checkbox('is checked');
    };

    const getShowAxisLabels = () => {
      return $('.showAxisLabels').checkbox('is checked');
    };

    const getShowSelectedLines = () => {
      return $('#showSelectedLinesCheck').checkbox('is checked');
    };

    const getShowUnselectedLines = () => {
      return $('#showUnselectedLinesCheck').checkbox('is checked');
    };
 
    // fileInput.addEventListener('change', () => {
    //   const file = fileInput.files[0];
    //   reader = new FileReader();
    //   reader.addEventListener('load', parseFile, false);
    //   if (file) {
    //     reader.readAsText(file);
    //     $('#fileLabel').html(file.name);
    //   }
    // });

    const loadFile = (file) => {
      if (file) {
        reader = new FileReader();
        reader.addEventListener('load', parseFile, false);
        reader.readAsText(file);
        // $('input:text', $(e.target).parent()).val(name);
        // $('fileOpenTextField').val(file.name);
      }
    }

    const parseFile = () => {
      data = d3.csvParse(reader.result, d3.autoType);
      console.log(data);

      let dimensions = data.columns.map(c => {
        if (data[0][c] instanceof Date) return {name: c, type: 'temporal'};
        else if (data[0][c] instanceof Boolean) return {name: c, type: 'categorical'};
        else if (typeof data[0][c] === 'string') return {name: c, type: 'categorical'};
        else if (typeof data[0][c] === 'number') return {name: c, type: 'numerical'};
        else return {name: c, type: 'unknown'};
      });
      dimensions = dimensions.filter(d => d.type !== 'unknown');

      const tuples = data.map(d => {
        let tuple = {};
        dimensions.map(dim => tuple[dim.name] = d[dim.name]);
        return tuple;
      });

      chartData = {dimensions: dimensions, tuples: tuples};
      createChart();
    };

    function loadCarsData() {
      d3.csv("data/cars-cat.csv", d3.autoType)
        .then(data => {
          chartData = {
            dimensions: [
              {name: 'MPG', type: 'numerical'},
              {name: 'Cylinders', type: 'categorical'},
              {name: 'Origin', type: 'categorical'},
              {name: 'Displacement', type: 'numerical'},
              {name: 'HP', type: 'numerical'},
              {name: 'Weight', type: 'numerical'},
              {name: 'Acceleration', type: 'numerical'},
              {name: 'Year', type: 'numerical'}
            ],
            tuples: data.map(d => {
              return {
                // MPG: Math.random() > 0.5 ? d.MPG : NaN,
                MPG: d.MPG,
                Cylinders: d.Cylinders,
                Displacement: d.Displacement,
                HP: d.HP,
                Weight: d.Weight,
                Acceleration: d.Acceleration,
                Year: d.Year,
                Origin: d.Origin
              }
            })
          };
          createChart();
        })
        .catch(error => {
          console.log(error);
        });
    };

    function loadAAPLData() {
      // console.log('loading AAPL data');
      d3.csv("data/AAPL_data.csv", d3.autoType)
        .then(data => {
          chartData = {
            dimensions: [
              {name: 'Date', type: 'temporal'},
              {name: 'Open', type: 'numerical'},
              {name: 'High', type: 'numerical'},
              {name: 'Low', type: 'numerical'},
              {name: 'Close', type: 'numerical'},
              {name: 'Volume', type: 'numerical'},
            ],
            tuples: data.map(d => {
              return {
                Date: d.date,
                Open: d.open,
                High: d.high,
                Low: d.low,
                Close: d.close,
                Volume: d.volume
              }
            })
          };
          createChart();
        })
        .catch(error => { console.log(error); });
    };

    function createChart() {
      d3.select('#chart').selectAll('*').remove();
      if (chartData) {
        const chartWidth = document.getElementById('pcpChart').clientWidth;
        const chartHeight = getChartHeight();
        console.log(`chartHeight is ${chartHeight}`);
     
        document.getElementById('pcpChart').style.height = `${chartHeight}px`;

        // let opacity = chartData.tuples.length > 2000 ? 0.1 : chartData.tuples.length < 500 ? 0.7 : 1 - chartData.tuples.length / 2500;
        // console.log(opacity);
        // selectedLineOpacityRange.value = opacity;
        // unselectedLineOpacityRange.value = opacity;

        console.log('showAxisTicks = ' + getShowAxisTicks());
        console.log(getShowAxisLabels());
        chart = pcpChart()
          .width(chartWidth)
          .height(chartHeight)
          .showUnselectedLines(getShowUnselectedLines())
          .showSelectedLines(getShowSelectedLines())
          .unselectedLineOpacity(getUnselectedLineOpacity())
          .selectedLineOpacity(getUnselectedLineOpacity())
          .showAxisTicks(getShowAxisTicks())
          .showAxisTickLabels(getShowAxisLabels())
          .margin(chartMargin);
        d3.select('#pcpChart').call(chart, chartData);
      }
    }

    document.getElementById('selectedLineOpacityRange').addEventListener('change', () => {
      console.log(`selected line opacity range is now ${getSelectedLineOpacity()}`);
      chart ? chart.selectedLineOpacity(getSelectedLineOpacity()) : null;
    });
      
    document.getElementById('unselectedLineOpacityRange').addEventListener('change', () => {
      console.log(`unselected line opacity range is now ${getUnselectedLineOpacity()}`);
      chart ? chart.unselectedLineOpacity(getUnselectedLineOpacity()) : null;
    });

    document.getElementById('chartHeightRange').addEventListener('change', () => {
      // TODO: Replace with call to chart to recreate chart elements without recreating the whole chart and losing selections
      chart ? createChart() : null;
    });

    $('.ui.checkbox.showSelectedLines').checkbox({
      onChecked: function() {
        console.log('checked');
        chart ? chart.showSelectedLines(true) : null;
      },
      onUnchecked: function() {
        console.log('unchecked');
        chart ? chart.showSelectedLines(false) : null;
      }
    });

    $('.ui.checkbox.showUnselectedLines').checkbox({
      onChecked: function() {
        console.log('checked');
        chart ? chart.showUnselectedLines(true) : null;
      },
      onUnchecked: function() {
        console.log('unchecked');
        chart ? chart.showUnselectedLines(false) : null;
      }
    });

    $('.ui.checkbox.showAxisTicks').checkbox({
      onChecked: function() {
        console.log('checked');
        chart ? chart.showAxisTicks(true) : null;
      },
      onUnchecked: function() {
        console.log('unchecked');
        chart ? chart.showAxisTicks(false) : null;
      }
    });

    $('.ui.checkbox.showAxisLabels').checkbox({
      onChecked: function() {
        console.log('checked');
        chart ? chart.showAxisTickLabels(true) : null;
      },
      onUnchecked: function() {
        console.log('unchecked');
        chart ? chart.showAxisTickLabels(false) : null;
      }
    });

    $('.ui.modal.settingsModal')
      .modal('attach events', '.settingsItem', 'show')
    ;
    $('.ui.modal.loadDataModal')
      .modal('attach events', '.loadDataItem', 'show')
    ;
    $('.ui.dropdown')
      .dropdown()
    ;

    $('.loadLocalFileItem')
      .on('click', function(e) {
        console.log('clicked loadLocalFileItem');
        $('#fileInput').click();
        // $(this).parent().find('input:file').click();
      });

    $('#fileInput')
      .on('change', function(e) {
        console.log(e.target.files[0]);
        if (e.target.files) {
          loadFile(e.target.files[0]);
        }
      });
    
    $('.loadCarsDataItem')
      .on('click', () => {
        console.log('loading cars data');
        loadCarsData();
      });
    // $('.loadTop500DataItem')
    //   .on('click', () => {
    //     console.log('loading top500 data');
    //     loadTop500Data();
    //   });
    $('.loadAAPLDataItem')
      .on('click', () => {
        console.log('loading stock data');
        loadAAPLData();
      });

    // $("input:text").click(function() {
    //   $(this).parent().find('input:file').click();
    // });

    // $('input:file', '.ui.action.input')
    //   .on('change', function(e) {
    //     if (e.target.files) {
    //       loadFile(e.target.files[0]);
    //       $('input:text', $(e.target).parent()).val(e.target.files[0].name);
    //     } else {
    //       $('input:text', $(e.target).parent()).val('');
    //     }
    //   });

    $('.redrawItem')
      .on('click', () => createChart());


  </script>
</body>

</html>